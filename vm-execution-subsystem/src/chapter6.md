# 类文件结构

## 概述

- 计算机只认识0和1,所以我们写的程序需要被编译器翻译成由0和1构成的二进制格式,才能被计算机执行
- 由于虚拟机以及大量建立在虚拟机之上的程序语言如雨后春笋般出现并蓬勃发展
    - 把我们编写的程序编译成二进制本地机器码(Native Code)已不再是唯一的选择,越来越多的程序语言选择了与操作系统和机器指令集无关的,平台中立的格式作为程序编译后的存储格式

## 无关性的基石

- 各种不同平台的Java虚拟机,以及所有平台都统一支持的程序存储格式——字节码(Byte Code)是构成平台无关性的基石
- 实现语言无关性的基础仍然是虚拟机和字节码存储格式
- Java虚拟机不与包括Java语言在内的任何程序语言绑定,它只与"Class文件"这种特定的二进制文件格式所关联,Class文件中包含了Java虚拟机指令集,符号表以及若干其他辅助信息

## Class类文件的结构

- 任何一个Class文件都对应着唯一的一个类或接口的定义信息,但是反过来说,类或接口并不一定都得定义在文件里(譬如类或接口也可以动态生成,直接送入类加载器中)

- Class基本结构
    - Class文件是一组以8个字节为基础单位的二进制流
    - 各个数据项目严格按照顺序紧凑地排列在文件之中,中间没有添加任何分隔符,整个Class文件中存储的内容几乎全部是程序运行的必要数据,没有空隙存在
    - 需要占用8个字节以上空间的数据项时,则会按照高位在前的方式分割成若干个8个字节进行存储

- Class文件格式采用一种类似于C语言结构体的伪结构来存储数据,伪结构中只有两种数据类型,无符号数和表
    - 无符号数属于基本的数据类型
        - 以u1,u2,u4,u8来分别代表1个字节,2个字节,4个字节和8个字节的无符号数
        - 无符号数可以用来描述数字,索引引用,数量值或者按照UTF8编码构成字符串值
    - 表是由多个无符号数或者其他表作为数据项构成的复合数据类型,为了便于区分,所有表的命名都习惯性地以"_info"结尾
        - 表用于描述有层次关系的复合结构的数据,整个Class文件本质上也可以视作是一张表

### 魔数与Class文件的版本

- 每个Class文件的头4个字节被称为魔数(Magic Number),它的唯一作用是确定这个文件是否为一个能被虚拟机接受的Class文件
    - Class文件的魔数取得很有浪漫气息,值为0xCAFEBABE(咖啡宝贝)
- 紧接着魔数的4个字节存储的是Class文件的版本号,高版本的JDK能向下兼容以前版本的Class文件,但不能运行以后版本的Class文件
    - 第5和第6个字节是次版本号
    - 第7和第8个字节是主版本号,版本号从45开始,JDK版本为13

### 常量池

- 紧接着主,次版本号之后的是常量池入口,常量池可以比喻为Class文件里的资源仓库
    - 它是Class文件结构中与其他项目关联最多的数据,通常也是占用Class文件空间最大的数据项目之一,另外,它还是在Class文件中第一个出现的表类型数据项目
    - 由于常量池中常量的数量是不固定的,所以在常量池的入口需要放置一项u2类型的数据,代表常量池容量计数值(constant_pool_count)
        - 常量池容量(偏移地址：0x00000008)为十六进制数0x0016,即十进制的22,这就代表常量池中有21项常量,索引值范围为1~21
    - Class文件结构中只有常量池的容量计数是从1开始,对于其他集合类型,包括接口索引集合,字段表集合,方法表集合等的容量计数都与一般习惯相同,是从0开始


- 常量池中主要存放两大类常量
    - 字面量(Literal),如文本字符串,被声明为final的常量值等
    - 符号引用(Symbolic References),属于编译原理方面的概念
        - 被模块导出或者开放的包(Package)
        - 类和接口的全限定名(Fully Qualified Name)
        - 字段的名称和描述符(Descriptor)
        - 方法的名称和描述
        - 方法句柄和方法类型(Method Handle,Method Type,Invoke Dynamic)
        - 动态调用点和动态常量(Dynamically-Computed Call Site,Dynamically-Computed Constant)




















